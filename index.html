<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡ç›¡è©¦ç…‰ä¹‹å¡”</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --accent-color: #ffd700;
            --rare-color: #a335ee;
            --danger-color: #ff5555;
            --success-color: #55ff55;
            --panel-bg: #1e1e1e;
            --border-color: #333;
            --card-hover: #2c2c2c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        .game-container {
            width: 100%;
            max-width: 900px; /* åŠ å¯¬ä»¥å®¹ç´è·æ¥­å¡ç‰‡ */
            background-color: var(--panel-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 25px rgba(0,0,0,0.9);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            max-height: 95vh;
            overflow-y: auto; /* é˜²æ­¢å°è¢å¹•çˆ†ç‰ˆ */
        }

        h1, h2, h3 { text-align: center; margin: 5px 0; color: var(--accent-color); }
        p { margin: 5px 0; line-height: 1.4; }
        .highlight { color: var(--accent-color); font-weight: bold; }
        .danger { color: var(--danger-color); }
        .success { color: var(--success-color); }
        .desc-text { color: #aaa; font-size: 0.85rem; }

        /* --- è·æ¥­é¸æ“‡å¡ç‰‡æ¨£å¼ (æ–°) --- */
        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .class-card {
            background: #252525;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .class-card:hover {
            background: var(--card-hover);
            border-color: var(--accent-color);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .class-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .class-name { font-weight: bold; font-size: 1.1rem; color: #fff; margin-bottom: 5px; }
        .class-role { color: var(--accent-color); font-size: 0.8rem; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .class-stats { font-size: 0.8rem; color: #bbb; text-align: left; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; margin-top: auto;}
        
        /* é ‚éƒ¨è³‡è¨Šæ¬„ */
        .top-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            background: #252525;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            text-align: center;
        }

        .main-content {
            display: flex;
            gap: 10px;
            height: 350px;
        }

        /* éŠæˆ²æ—¥èªŒ */
        .game-log {
            flex: 2;
            background: #000;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #1a1a1a; padding-bottom: 2px;}

        /* è£å‚™æ¬„ä½ */
        .equipment-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
            background: #2a2a2a;
            padding: 5px;
            border-radius: 5px;
            font-size: 0.8rem;
            overflow-y: auto;
        }

        .equip-slot {
            background: #333;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .equip-slot span.label { color: #888; font-size: 0.7rem; }
        .equip-slot span.item-name { color: var(--accent-color); font-weight: bold; }

        /* æŒ‰éˆ•å€åŸŸ */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            min-height: 50px;
        }

        button {
            background-color: #3a3a3a;
            color: white;
            border: 1px solid #555;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            flex: 1;
        }
        button:hover { background-color: #505050; border-color: #999; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-atk { background: #6a1b1b; }
        .btn-heal { background: #1b6a1b; }
        .btn-loot { background: var(--rare-color); color: white; }
        .btn-achievement { background: #b8860b; color: black; font-weight: bold; flex: 0 0 100%; margin-top: 5px;}

        /* å½ˆå‡ºè¦–çª— (é€šç”¨) */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: #222;
            border: 2px solid var(--accent-color);
            padding: 20px;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* è£å‚™æ¯”è¼ƒæ¨£å¼ */
        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .compare-card { background: #333; padding: 10px; border-radius: 5px; }
        .stat-diff-pos { color: var(--success-color); }
        .stat-diff-neg { color: var(--danger-color); }

        /* æˆå°±åˆ—è¡¨æ¨£å¼ */
        .achieve-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            text-align: left;
        }
        .achieve-item {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0.5;
            filter: grayscale(1);
        }
        .achieve-item.unlocked {
            opacity: 1;
            filter: grayscale(0);
            border-color: var(--accent-color);
            background: #2a2200;
        }
        .achieve-info h4 { margin: 0; text-align: left; color: var(--accent-color); }
        .achieve-info p { margin: 2px 0 0; font-size: 0.8rem; color: #aaa; }
        .achieve-status { font-size: 1.2rem; }

        /* æˆå°±é€šçŸ¥ (Toast) */
        #notification-area {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 300px; pointer-events: none; z-index: 200;
        }
        .toast {
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 15px; margin-bottom: 10px; border-radius: 5px;
            text-align: center;
            animation: slideDown 0.5s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
            box-shadow: 0 0 10px var(--accent-color);
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        .screen { display: none; }
        .active { display: block; }
        
        @media (max-width: 700px) {
            .class-grid { grid-template-columns: 1fr 1fr; }
            .main-content { flex-direction: column-reverse; height: auto; }
            .game-log { height: 200px; }
        }
    </style>
</head>
<body>

<div class="game-container">
    <div id="notification-area"></div>

    <h1>ğŸ° ç„¡ç›¡è©¦ç…‰ v3.1</h1>

    <div id="screen-start" class="screen active">
        <h3>è«‹é¸æ“‡ä½ çš„è‹±é›„</h3>
        <p style="text-align:center; color:#888; font-size:0.9rem; margin-bottom: 20px;">æ¯å€‹è·æ¥­éƒ½æœ‰ç¨ç‰¹çš„å±¬æ€§èˆ‡åˆå§‹è£å‚™</p>
        
        <div class="class-grid">
            <div class="class-card" onclick="startGame('barbarian')">
                <div class="class-icon">ğŸª“</div>
                <div class="class-name">é‡è »äºº</div>
                <div class="class-role">ç‹‚æˆ°å£«</div>
                <p class="desc-text">é«”è³ªå¼·å¥ï¼Œæ”»æ“ŠåŠ›ä¸ä¿—ã€‚ä¾é é«˜è¡€é‡å’Œå¼·åŠ›é‡æ“Šç¢¾å£“æ•µäººï¼Œç°¡å–®æš´åŠ›ã€‚</p>
                <div class="class-stats">
                    â¤ï¸ ç”Ÿå‘½: <span class="success">æ¥µé«˜</span><br>
                    âš”ï¸ æ”»æ“Š: <span class="highlight">é«˜</span><br>
                    ğŸ›¡ï¸ é˜²ç¦¦: <span class="danger">ä½</span>
                </div>
            </div>

            <div class="class-card" onclick="startGame('assassin')">
                <div class="class-icon">ğŸ—¡ï¸</div>
                <div class="class-name">åˆºå®¢</div>
                <div class="class-role">çˆ†æ“Šæµ</div>
                <p class="desc-text">èº«æ¿è„†å¼±ï¼Œä½†æ“æœ‰æ¥µé«˜çš„çˆ†æ“Šç‡ã€‚é‹æ°£å¥½æ™‚èƒ½ç¬é–“ç§’æ®ºå¼·æ•µã€‚</p>
                <div class="class-stats">
                    â¤ï¸ ç”Ÿå‘½: <span class="danger">ä½</span><br>
                    âš”ï¸ æ”»æ“Š: <span class="success">ä¸­</span><br>
                    âš¡ çˆ†æ“Š: <span class="highlight">æ¥µé«˜</span>
                </div>
            </div>

            <div class="class-card" onclick="startGame('mage')">
                <div class="class-icon">ğŸ”¥</div>
                <div class="class-name">æ³•å¸«</div>
                <div class="class-role">ç»ç’ƒå¤§ç ²</div>
                <p class="desc-text">æ“æœ‰æ¯€æ»…æ€§çš„æ”»æ“ŠåŠ›ï¼Œä½†é˜²ç¦¦æ¥µä½ã€‚å¿…é ˆåœ¨æ•µäººé è¿‘å‰å°‡å…¶æ¶ˆæ»…ã€‚</p>
                <div class="class-stats">
                    â¤ï¸ ç”Ÿå‘½: <span class="danger">æ¥µä½</span><br>
                    âš”ï¸ æ”»æ“Š: <span class="highlight">æ¥µé«˜</span><br>
                    ğŸ›¡ï¸ é˜²ç¦¦: <span class="danger">ç„¡</span>
                </div>
            </div>

            <div class="class-card" onclick="startGame('warlock')">
                <div class="class-icon">ğŸ”®</div>
                <div class="class-name">è¡“å£«</div>
                <div class="class-role">å¸è¡€çºŒèˆª</div>
                <p class="desc-text">æ•¸å€¼å¹³è¡¡ï¼Œæ”»æ“Šæ™‚æœƒå¸å–æ•µäººç”Ÿå‘½ã€‚ç”Ÿå­˜èƒ½åŠ›æ¥µå¼·ï¼Œé©åˆæŒä¹…æˆ°ã€‚</p>
                <div class="class-stats">
                    â¤ï¸ ç”Ÿå‘½: <span class="success">ä¸­</span><br>
                    âš”ï¸ æ”»æ“Š: <span class="success">ä¸­</span><br>
                    ğŸ©¸ ç‰¹æ•ˆ: <span class="highlight">æ”»æ“Šå¸è¡€</span>
                </div>
            </div>

            <div class="class-card" onclick="startGame('knight')">
                <div class="class-icon">ğŸ›¡ï¸</div>
                <div class="class-name">é¨å£«</div>
                <div class="class-role">éµå£é˜²ç¦¦</div>
                <p class="desc-text">é«˜é˜²ç¦¦åŠ›èˆ‡ç›¾ç‰Œæ ¼æ“‹ï¼Œèƒ½å¤§å¹…æ¸›è¼•å‚·å®³ã€‚é›–ç„¶æ”»æ“Šè¼ƒä½ï¼Œä½†æœ€ç‚ºç©©å¥ã€‚</p>
                <div class="class-stats">
                    â¤ï¸ ç”Ÿå‘½: <span class="success">é«˜</span><br>
                    âš”ï¸ æ”»æ“Š: <span class="danger">ä½</span><br>
                    ğŸ›¡ï¸ é˜²ç¦¦: <span class="highlight">æ¥µé«˜</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-achievement" onclick="showAchievements()">ğŸ† æŸ¥çœ‹æˆå°±åˆ—è¡¨</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="top-panel">
            <div><span id="ui-class"></span> Lv.<span id="ui-floor">1</span></div>
            <div class="danger">HP <span id="ui-hp"></span>/<span id="ui-maxhp"></span></div>
            <div class="highlight">ATK <span id="ui-atk"></span></div>
            <div class="success">DEF <span id="ui-def"></span></div>
        </div>

        <div class="main-content">
            <div class="equipment-grid" id="equip-display"></div>
            <div id="game-log" class="game-log"></div>
        </div>

        <div class="controls" id="action-area"></div>
    </div>

    <div id="screen-over" class="screen" style="text-align:center;">
        <h2 class="danger">ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
        <p>æœ€çµ‚å±¤æ•¸: <span id="final-floor" class="highlight"></span></p>
        <div class="controls">
            <button onclick="location.reload()">é‡æ–°é–‹å§‹</button>
            <button class="btn-achievement" onclick="showAchievements()">ğŸ† æŸ¥çœ‹æˆå°±</button>
        </div>
    </div>
</div>

<div id="modal-loot" class="modal-overlay">
    <div class="modal-content">
        <h3>ğŸ ç²å¾—æˆ°åˆ©å“!</h3>
        <div class="compare-grid">
            <div class="compare-card" style="opacity: 0.7;">
                <h4>ç›®å‰è£å‚™</h4>
                <div id="loot-current">ç„¡</div>
            </div>
            <div class="compare-card" style="border: 1px solid var(--accent-color);">
                <h4 class="highlight">æ–°è£å‚™</h4>
                <div id="loot-new"></div>
            </div>
        </div>
        <div class="controls">
            <button class="btn-heal" onclick="confirmLoot(true)">è£å‚™</button>
            <button class="btn-atk" onclick="confirmLoot(false)">ä¸Ÿæ£„</button>
        </div>
    </div>
</div>

<div id="modal-achievements" class="modal-overlay" onclick="if(event.target === this) this.style.display='none'">
    <div class="modal-content">
        <h3>ğŸ† æˆå°±ç´€éŒ„</h3>
        <p style="text-align:center; font-size:0.8rem; color:#888;">æˆå°±é€²åº¦æœƒè‡ªå‹•å„²å­˜åœ¨æ­¤ç€è¦½å™¨ä¸­</p>
        <div id="achievement-list" class="achieve-grid"></div>
        <div class="controls" style="margin-top:20px;">
            <button onclick="document.getElementById('modal-achievements').style.display='none'">é—œé–‰</button>
            <button class="btn-atk" onclick="resetAchievements()">é‡ç½®æˆå°±</button>
        </div>
    </div>
</div>

<script>
    /* --- éŠæˆ²è³‡æ–™èˆ‡å¸¸æ•¸ --- */
    const CLASSES = {
        barbarian: { name: "é‡è »äºº", hp: 130, atk: 12, def: 2 }, // å¾®èª¿é‡è »äººHP
        assassin: { name: "åˆºå®¢", hp: 80, atk: 15, def: 1 },
        mage: { name: "æ³•å¸«", hp: 60, atk: 22, def: 0 }, // å¾®èª¿æ³•å¸«æ”»æ“Š
        warlock: { name: "è¡“å£«", hp: 90, atk: 12, def: 1 },
        knight: { name: "é¨å£«", hp: 110, atk: 9, def: 6 } // å¾®èª¿é¨å£«é˜²ç¦¦
    };

    const SLOTS = ['mainHand', 'offHand', 'chest', 'helm', 'boots', 'ring', 'necklace'];
    const SLOT_NAMES = { mainHand: "ä¸»æ‰‹", offHand: "å‰¯æ‰‹", chest: "èƒ¸ç”²", helm: "é ­ç›”", boots: "é‹å­", ring: "æˆ’æŒ‡", necklace: "é …éŠ" };

    const ACHIEVEMENTS = [
        { id: 'first_step', title: 'åˆå‡ºèŒ…å»¬', desc: 'é–‹å§‹ç¬¬ä¸€æ¬¡éŠæˆ²' },
        { id: 'floor_10', title: 'æ¢éšªå®¶', desc: 'åˆ°é”ç¬¬ 10 å±¤' },
        { id: 'floor_30', title: 'æ·±æ·µè¡Œè€…', desc: 'åˆ°é”ç¬¬ 30 å±¤' },
        { id: 'floor_50', title: 'å‚³å¥‡è‹±é›„', desc: 'åˆ°é”ç¬¬ 50 å±¤' },
        { id: 'high_dmg', title: 'ä¸€æ“Šå¿…æ®º', desc: 'å–®æ¬¡æ”»æ“Šé€ æˆè¶…é 80 é»å‚·å®³' },
        { id: 'iron_wall', title: 'éŠ…ç‰†éµå£', desc: 'é˜²ç¦¦åŠ›è¶…é 25' },
        { id: 'full_gear', title: 'å…¨å‰¯æ­¦è£', desc: 'æ‰€æœ‰è£å‚™æ¬„ä½éƒ½ç©¿ä¸Šè£å‚™' },
        { id: 'rich', title: 'è²¡å¯Œè‡ªç”±', desc: 'æŒæœ‰é‡‘å¹£è¶…é 500' },
        { id: 'hoarder', title: 'è—¥ç½å­', desc: 'åŒæ™‚æŒæœ‰ 10 ç“¶è—¥æ°´' },
        { id: 'lucky', title: 'å¹¸é‹ä¸€æ“Š', desc: 'è§¸ç™¼ä¸€æ¬¡çˆ†æ“Š' },
        { id: 'untouchable', title: 'æ¯«é«®ç„¡å‚·', desc: 'å—åˆ°æ”»æ“Šä½†å‚·å®³ç‚º 0' },
        { id: 'death', title: 'å‹‡è€…é•·çœ ', desc: 'ç¬¬ä¸€æ¬¡æ­»äº¡' }
    ];

    const ITEM_DB = {
        mainHand: [
            { name: "ç”Ÿé½éµåŠ", stats: { atk: 3 }, allowed: null },
            { name: "æˆ°æ–§", stats: { atk: 6, spd: -1 }, allowed: ['barbarian', 'knight'] },
            { name: "æ¯’ç‰™åŒ•é¦–", stats: { atk: 3, crit: 5 }, allowed: ['assassin', 'warlock'] },
            { name: "è€èˆŠæ³•æ–", stats: { atk: 7 }, allowed: ['mage', 'warlock'] },
            { name: "é¨å£«é•·åŠ", stats: { atk: 5, def: 1 }, allowed: ['knight'] },
            { name: "é›·ç¥ä¹‹éŒ˜", stats: { atk: 9 }, allowed: ['barbarian'] },
            { name: "å„€å¼éª¨åˆ€", stats: { atk: 4, hp: 10 }, allowed: ['warlock'] },
            { name: "ç¦å¿Œé­”å…¸", stats: { atk: 8 }, allowed: ['mage'] },
            { name: "æš—å½±ä¹‹åˆƒ", stats: { atk: 6, crit: 4 }, allowed: ['assassin'] },
            { name: "å‹‡è€…ä¹‹åŠ", stats: { atk: 10 }, allowed: null }
        ],
        offHand: [
            { name: "æœ¨ç›¾", stats: { def: 2 }, allowed: ['knight', 'barbarian'] },
            { name: "éµåœ“ç›¾", stats: { def: 4 }, allowed: ['knight'] },
            { name: "æ°´æ™¶çƒ", stats: { atk: 2 }, allowed: ['mage', 'warlock'] },
            { name: "æ‹›æ¶åŒ•é¦–", stats: { def: 1, crit: 2 }, allowed: ['assassin'] },
            { name: "ç¤¦å·¥æç‡ˆ", stats: { def: 1, hp: 5 }, allowed: null }
        ],
        chest: [
            { name: "çš®ç”²", stats: { def: 2 }, allowed: null },
            { name: "é–å­ç”²", stats: { def: 5 }, allowed: ['knight', 'barbarian'] },
            { name: "æ³•å¸«é•·è¢", stats: { def: 1, atk: 3 }, allowed: ['mage', 'warlock'] },
            { name: "é‡å‹æ¿ç”²", stats: { def: 9, spd: -2 }, allowed: ['knight'] },
            { name: "åˆºå®¢æŠ«é¢¨", stats: { def: 2, crit: 2 }, allowed: ['assassin'] }
        ],
        helm: [
            { name: "é ­å¸¶", stats: { atk: 1 }, allowed: null },
            { name: "åå­—è»é ­ç›”", stats: { def: 4 }, allowed: ['knight'] },
            { name: "ç¸è§’ç›”", stats: { def: 2, hp: 10 }, allowed: ['barbarian'] },
            { name: "ç¥ç§˜å…œå¸½", stats: { def: 1, atk: 1 }, allowed: ['mage', 'warlock'] }
        ],
        boots: [
            { name: "èˆŠçš®é´", stats: { def: 1 }, allowed: null },
            { name: "é‹¼éµæˆ°é´", stats: { def: 3 }, allowed: ['knight'] },
            { name: "è¼•éˆä¹‹é´", stats: { atk: 1 }, allowed: ['mage', 'assassin'] }
        ],
        ring: [
            { name: "éµæˆ’æŒ‡", stats: { def: 1 }, allowed: null },
            { name: "ç´…å¯¶çŸ³æˆ’", stats: { atk: 2 }, allowed: null },
            { name: "ç”Ÿå‘½ä¹‹æˆ’", stats: { hp: 15 }, allowed: null },
            { name: "å¹¸é‹æŒ‡ç’°", stats: { crit: 2 }, allowed: null }
        ],
        necklace: [
            { name: "å®ˆè­·è­·ç¬¦", stats: { def: 2 }, allowed: null },
            { name: "ç‹¼ç‰™é …éŠ", stats: { atk: 1, crit: 1 }, allowed: null },
            { name: "è—å¯¶çŸ³å¢œ", stats: { atk: 3 }, allowed: null }
        ]
    };

    /* --- éŠæˆ²ç‹€æ…‹ --- */
    let player = { base: {}, currentHp: 0, potions: 2, gold: 0, equipment: {}, classKey: '' };
    let floor = 0;
    let tempLoot = null;
    let enemy = null;
    let unlockedAchievements = [];

    window.onload = function() { loadAchievements(); };

    /* --- æˆå°±ç³»çµ± --- */
    function loadAchievements() {
        const stored = localStorage.getItem('tower_game_achievements');
        if (stored) unlockedAchievements = JSON.parse(stored);
    }
    function checkAchievement(id) {
        if (!unlockedAchievements.includes(id)) {
            unlockedAchievements.push(id);
            localStorage.setItem('tower_game_achievements', JSON.stringify(unlockedAchievements));
            const ach = ACHIEVEMENTS.find(a => a.id === id);
            showToast(`ğŸ† æˆå°±è§£é–ï¼š${ach.title}`);
        }
    }
    function showToast(msg) {
        const area = document.getElementById('notification-area');
        const div = document.createElement('div');
        div.className = 'toast';
        div.innerHTML = msg;
        area.appendChild(div);
        setTimeout(() => div.remove(), 3500);
    }
    function resetAchievements() {
        if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æˆå°±ç´€éŒ„å—ï¼Ÿ")) {
            localStorage.removeItem('tower_game_achievements');
            unlockedAchievements = [];
            showAchievements();
        }
    }
    function showAchievements() {
        const list = document.getElementById('achievement-list');
        list.innerHTML = '';
        ACHIEVEMENTS.forEach(ach => {
            const isUnlocked = unlockedAchievements.includes(ach.id);
            const div = document.createElement('div');
            div.className = `achieve-item ${isUnlocked ? 'unlocked' : ''}`;
            div.innerHTML = `
                <div class="achieve-info">
                    <h4>${ach.title}</h4>
                    <p>${ach.desc}</p>
                </div>
                <div class="achieve-status">${isUnlocked ? 'âœ…' : 'ğŸ”’'}</div>
            `;
            list.appendChild(div);
        });
        document.getElementById('modal-achievements').style.display = 'flex';
    }

    /* --- æ ¸å¿ƒé‚è¼¯ --- */
    function log(msg, type='') {
        const el = document.getElementById('game-log');
        const div = document.createElement('div');
        div.className = 'log-entry ' + type;
        div.innerHTML = msg;
        el.appendChild(div);
        el.scrollTop = el.scrollHeight;
    }

    function startGame(classKey) {
        const cls = CLASSES[classKey];
        player = {
            classKey: classKey,
            base: { ...cls },
            currentHp: cls.hp,
            potions: 2,
            gold: 0,
            equipment: {}
        };
        SLOTS.forEach(slot => player.equipment[slot] = null);
        
        floor = 0;
        document.getElementById('screen-start').classList.remove('active');
        document.getElementById('screen-over').classList.remove('active');
        document.getElementById('screen-game').classList.add('active');
        
        // åˆå§‹è£å‚™é…ç½®
        const starterWeapons = {
            barbarian: ITEM_DB.mainHand[1],
            assassin: ITEM_DB.mainHand[2],
            mage: ITEM_DB.mainHand[3],
            warlock: ITEM_DB.mainHand[6],
            knight: ITEM_DB.mainHand[4]
        };
        equip(JSON.parse(JSON.stringify(starterWeapons[classKey])), 'mainHand', true);

        checkAchievement('first_step');
        updateUI();
        log(`ä½ é¸æ“‡äº† <span class="highlight">${cls.name}</span>ï¼Œæº–å‚™å¥½é¢å°è©¦ç…‰äº†å—ï¼Ÿ`);
        nextFloor();
    }

    function getPlayerStats() {
        let stats = { hp: player.base.hp, atk: player.base.atk, def: player.base.def, crit: 0 };
        for (let slot of SLOTS) {
            const item = player.equipment[slot];
            if (item && item.stats) {
                if (item.stats.hp) stats.hp += item.stats.hp;
                if (item.stats.atk) stats.atk += item.stats.atk;
                if (item.stats.def) stats.def += item.stats.def;
                if (item.stats.crit) stats.crit += item.stats.crit;
            }
        }
        return stats;
    }

    function updateUI() {
        const stats = getPlayerStats();
        if (player.currentHp > stats.hp) player.currentHp = stats.hp;

        document.getElementById('ui-class').innerText = CLASSES[player.classKey].name;
        document.getElementById('ui-floor').innerText = floor;
        document.getElementById('ui-hp').innerText = Math.floor(player.currentHp);
        document.getElementById('ui-maxhp').innerText = stats.hp;
        document.getElementById('ui-atk').innerText = stats.atk;
        document.getElementById('ui-def').innerText = stats.def;

        const grid = document.getElementById('equip-display');
        grid.innerHTML = '';
        SLOTS.forEach(slot => {
            const item = player.equipment[slot];
            const div = document.createElement('div');
            div.className = 'equip-slot';
            div.innerHTML = `<span class="label">${SLOT_NAMES[slot]}</span><span class="item-name">${item ? item.name : '---'}</span>`;
            if (item) {
                let txt = '';
                for (let k in item.stats) txt += `${k.toUpperCase()}+${item.stats[k]} `;
                div.title = txt;
            }
            grid.appendChild(div);
        });

        if (stats.def >= 25) checkAchievement('iron_wall');
        if (player.gold >= 500) checkAchievement('rich');
        if (player.potions >= 10) checkAchievement('hoarder');
        if (SLOTS.every(s => player.equipment[s] !== null)) checkAchievement('full_gear');
    }

    function nextFloor() {
        floor++;
        if (floor >= 10) checkAchievement('floor_10');
        if (floor >= 30) checkAchievement('floor_30');
        if (floor >= 50) checkAchievement('floor_50');

        updateUI();
        log(`<br>--- <strong>ç¬¬ ${floor} å±¤</strong> ---`, 'highlight');
        
        const rand = Math.random();
        if (floor % 10 === 0) encounterMonster(true);
        else if (rand < 0.7) encounterMonster(false);
        else triggerEvent();
    }

    function encounterMonster(isBoss) {
        const scale = 1 + (floor * 0.12); // å¾®å¹…å¢åŠ é›£åº¦æ›²ç·š
        const names = ["å²èŠå§†", "å“¥å¸ƒæ—", "éª·é«å…µ", "ç‹‚æš´ç¸äºº", "è©›å’’å¹½éˆ", "çŸ³åƒé¬¼", "é£Ÿäººé­”", "é»‘æš—é¨å£«", "é›™è¶³é£›é¾", "æ·±æ·µæƒ¡é­”"];
        const nameIdx = isBoss ? 9 : Math.min(names.length - 2, Math.floor(floor / 4));
        
        enemy = {
            name: (isBoss ? "â˜ ï¸ é¦–é ˜: " : "") + names[isBoss ? 9 : Math.floor(Math.random() * (nameIdx + 1))],
            maxHp: Math.floor((isBoss ? 200 : 35) * scale),
            currentHp: Math.floor((isBoss ? 200 : 35) * scale),
            atk: Math.floor((isBoss ? 18 : 6) * scale) + Math.floor(floor/2),
        };
        log(`é­é‡æ•µè¥²ï¼š<span class="danger">${enemy.name}</span> (HP:${enemy.maxHp}, ATK:${enemy.atk})`);
        renderCombatControls();
    }

    function renderCombatControls() {
        const area = document.getElementById('action-area');
        area.innerHTML = '';
        
        const atkBtn = document.createElement('button');
        atkBtn.className = 'btn-atk';
        atkBtn.innerText = 'âš”ï¸ æ”»æ“Š';
        atkBtn.onclick = combatRound;
        area.appendChild(atkBtn);

        const potBtn = document.createElement('button');
        potBtn.className = 'btn-heal';
        potBtn.innerText = `ğŸ§ª è—¥æ°´(${player.potions})`;
        potBtn.onclick = usePotion;
        if (player.potions <= 0) potBtn.disabled = true;
        area.appendChild(potBtn);
    }

    function combatRound() {
        const stats = getPlayerStats();
        
        // Player Attack
        let isCrit = Math.random() * 100 < stats.crit;
        if (isCrit) checkAchievement('lucky');
        let dmg = Math.floor(stats.atk * (isCrit ? 1.6 : 1) * (0.9 + Math.random()*0.2));
        
        if (player.classKey === 'warlock') {
            let heal = Math.ceil(dmg * 0.15); // å¸è¡€ 15%
            player.currentHp += heal;
            log(`(å¸è¡€) æ¢å¾©äº† ${heal} ç”Ÿå‘½`, 'success');
        }

        if (dmg >= 80) checkAchievement('high_dmg');
        enemy.currentHp -= dmg;
        log(`ä½ å° ${enemy.name} é€ æˆ ${dmg} å‚·å®³${isCrit?' (çˆ†æ“Š!)':''}ã€‚`);

        if (enemy.currentHp <= 0) {
            log(`æˆ°å‹äº† ${enemy.name}ï¼`, 'success');
            player.gold += Math.floor(Math.random() * 15) + floor;
            winReward();
            return;
        }

        // Enemy Attack
        let incoming = Math.max(1, Math.floor((enemy.atk - stats.def) * (0.9 + Math.random()*0.2)));
        
        // é¨å£«æ ¼æ“‹åˆ¤å®š
        if (player.classKey === 'knight' && Math.random() < 0.25) {
            incoming = Math.floor(incoming * 0.3); // æ¸›å‚· 70%
            log("ğŸ›¡ï¸ æ ¼æ“‹æˆåŠŸï¼å¤§å¹…æ¸›è¼•å‚·å®³ï¼", 'highlight');
        }
        // é«˜é˜²ç¦¦å®Œå…¨é˜²ç¦¦åˆ¤å®š
        else if (stats.def > enemy.atk * 1.2 && Math.random() > 0.6) {
            incoming = 0;
            checkAchievement('untouchable');
            log(`ğŸ›¡ï¸ å®Œç¾çš„é˜²ç¦¦ï¼`, 'success');
        }

        player.currentHp -= incoming;
        log(`${enemy.name} åæ“Šï¼Œä½ å—åˆ° ${incoming} å‚·å®³ã€‚`, 'danger');
        
        updateUI();
        if (player.currentHp <= 0) gameOver();
    }

    function usePotion() {
        if (player.potions > 0) {
            player.potions--;
            const heal = 60; // è—¥æ°´å¢å¼·
            const stats = getPlayerStats();
            player.currentHp = Math.min(stats.hp, player.currentHp + heal);
            log(`ä½¿ç”¨äº†è—¥æ°´ï¼Œå›å¾© ${heal} HPã€‚`, 'success');
            
            let incoming = Math.floor(enemy.atk * 0.8);
            player.currentHp -= incoming;
            log(`${enemy.name} è¶æ©Ÿæ”»æ“Šï¼Œé€ æˆ ${incoming} å‚·å®³ã€‚`);
            
            updateUI();
            if (player.currentHp <= 0) gameOver();
        }
    }

    function winReward() {
        if (Math.random() < 0.5) generateLoot();
        else {
            log("æ€ªç‰©æ‰è½äº†ä¸€äº›é‡‘å¹£ã€‚");
            renderNextButton();
        }
    }

    function triggerEvent() {
        const evts = [
            { t: "ç™¼ç¾å¯¶ç®±", act: () => { log("æ‰“é–‹å¯¶ç®±ï¼Œç™¼ç¾è£å‚™ï¼", 'highlight'); generateLoot(); } },
            { t: "é‡åˆ°å•†äºº", act: () => { log("å•†äººé€äº†ä½ ä¸€ç“¶è—¥æ°´ã€‚"); player.potions++; renderNextButton(); }},
            { t: "ç¥ç§˜æ³‰æ°´", act: () => { log("å–ä¸‹æ³‰æ°´ï¼Œå‚·å‹¢å®Œå…¨æ¢å¾©ã€‚", 'success'); player.currentHp = getPlayerStats().hp; renderNextButton(); }},
            { t: "å°éŒ¢è¢‹", act: () => { let g = 50 + floor*2; log(`æ’¿åˆ°éŒ¢è¢‹ï¼Œç²å¾— ${g} é‡‘å¹£ã€‚`, 'highlight'); player.gold += g; renderNextButton(); }}
        ];
        const evt = evts[Math.floor(Math.random() * evts.length)];
        log(`äº‹ä»¶: ${evt.t}`);
        evt.act();
        updateUI();
    }

    function generateLoot() {
        const slot = SLOTS[Math.floor(Math.random() * SLOTS.length)];
        let candidates = ITEM_DB[slot].filter(item => item.allowed === null || item.allowed.includes(player.classKey));
        if (candidates.length === 0) candidates = ITEM_DB[slot].filter(item => item.allowed === null);
        if (candidates.length === 0) { renderNextButton(); return; }

        const baseItem = candidates[Math.floor(Math.random() * candidates.length)];
        let newItem = JSON.parse(JSON.stringify(baseItem));
        newItem.slot = slot;
        
        const multiplier = 1 + (floor * 0.15);
        for (let key in newItem.stats) {
            if (newItem.stats[key] > 0) newItem.stats[key] = Math.ceil(newItem.stats[key] * multiplier * (0.8 + Math.random() * 0.4));
        }
        if (Math.random() < 0.25) {
            newItem.name = "ç²¾è‰¯çš„ " + newItem.name;
            newItem.stats.atk = (newItem.stats.atk || 0) + Math.ceil(floor/2);
        }

        tempLoot = newItem;
        showLootModal(newItem);
    }

    function showLootModal(newItem) {
        const modal = document.getElementById('modal-loot');
        const currentItem = player.equipment[newItem.slot];
        let curHtml = currentItem ? `<strong>${currentItem.name}</strong><br>` : "ç„¡<br>";
        if (currentItem) for (let k in currentItem.stats) curHtml += `${k.toUpperCase()}: ${currentItem.stats[k]}<br>`;
        document.getElementById('loot-current').innerHTML = curHtml;

        let newHtml = `<strong>${newItem.name}</strong><br>`;
        for (let k in newItem.stats) {
            let diff = newItem.stats[k] - (currentItem && currentItem.stats[k] ? currentItem.stats[k] : 0);
            let colorClass = diff > 0 ? 'stat-diff-pos' : (diff < 0 ? 'stat-diff-neg' : '');
            newHtml += `${k.toUpperCase()}: ${newItem.stats[k]} <span class="${colorClass}">(${diff>0?'+':''}${diff})</span><br>`;
        }
        document.getElementById('loot-new').innerHTML = newHtml;
        modal.style.display = 'flex';
    }

    function confirmLoot(accept) {
        document.getElementById('modal-loot').style.display = 'none';
        if (accept && tempLoot) equip(tempLoot, tempLoot.slot);
        tempLoot = null;
        renderNextButton();
    }

    function equip(item, slot, silent=false) {
        player.equipment[slot] = item;
        updateUI();
        if (!silent) log(`è£å‚™äº† <span class="highlight">${item.name}</span>ï¼`, 'success');
    }

    function renderNextButton() {
        const area = document.getElementById('action-area');
        area.innerHTML = '';
        const btn = document.createElement('button');
        btn.innerText = 'ğŸ‘£ å‰å¾€ä¸‹ä¸€å±¤';
        btn.onclick = nextFloor;
        area.appendChild(btn);
    }

    function gameOver() {
        checkAchievement('death');
        document.getElementById('screen-game').classList.remove('active');
        document.getElementById('screen-over').classList.add('active');
        document.getElementById('final-floor').innerText = floor;
    }
</script>
</body>
</html>

