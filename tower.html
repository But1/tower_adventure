<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡ç›¡è©¦ç…‰ä¹‹å¡” v3.0</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --accent-color: #ffd700;
            --rare-color: #a335ee;
            --danger-color: #ff4444;
            --success-color: #44ff44;
            --panel-bg: #1e1e1e;
            --border-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        .game-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }

        h1, h2, h3 { text-align: center; margin: 5px 0; color: var(--accent-color); }
        .highlight { color: var(--accent-color); font-weight: bold; }
        .danger { color: var(--danger-color); }
        .success { color: var(--success-color); }

        /* é ‚éƒ¨è³‡è¨Šæ¬„ */
        .top-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            background: #252525;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            text-align: center;
        }

        .main-content {
            display: flex;
            gap: 10px;
            height: 400px;
        }

        /* éŠæˆ²æ—¥èªŒ */
        .game-log {
            flex: 2;
            background: #000;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #1a1a1a; padding-bottom: 2px;}

        /* è£å‚™æ¬„ä½ */
        .equipment-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
            background: #2a2a2a;
            padding: 5px;
            border-radius: 5px;
            font-size: 0.8rem;
            overflow-y: auto;
        }

        .equip-slot {
            background: #333;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .equip-slot span.label { color: #888; font-size: 0.7rem; }
        .equip-slot span.item-name { color: var(--accent-color); font-weight: bold; }

        /* æŒ‰éˆ•å€åŸŸ */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            min-height: 60px;
        }

        button {
            background-color: #3a3a3a;
            color: white;
            border: 1px solid #555;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            flex: 1;
        }
        button:hover { background-color: #505050; border-color: #999; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-atk { background: #5a1a1a; }
        .btn-heal { background: #1a5a1a; }
        .btn-loot { background: var(--rare-color); color: white; }
        .btn-achievement { background: #b8860b; color: black; font-weight: bold; flex: 0 0 100%; margin-top: 10px;}

        /* å½ˆå‡ºè¦–çª— (é€šç”¨) */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: #222;
            border: 2px solid var(--accent-color);
            padding: 20px;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* è£å‚™æ¯”è¼ƒæ¨£å¼ */
        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .compare-card { background: #333; padding: 10px; border-radius: 5px; }
        .stat-diff-pos { color: var(--success-color); }
        .stat-diff-neg { color: var(--danger-color); }

        /* æˆå°±åˆ—è¡¨æ¨£å¼ */
        .achieve-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            text-align: left;
        }
        .achieve-item {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0.5; /* é è¨­æœªè§£é– */
            filter: grayscale(1);
        }
        .achieve-item.unlocked {
            opacity: 1;
            filter: grayscale(0);
            border-color: var(--accent-color);
            background: #2a2200;
        }
        .achieve-info h4 { margin: 0; text-align: left; color: var(--accent-color); }
        .achieve-info p { margin: 2px 0 0; font-size: 0.8rem; color: #aaa; }
        .achieve-status { font-size: 1.2rem; }

        /* æˆå°±é€šçŸ¥ (Toast) */
        #notification-area {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            pointer-events: none;
            z-index: 200;
        }
        .toast {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            text-align: center;
            animation: slideDown 0.5s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
            box-shadow: 0 0 10px var(--accent-color);
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        .screen { display: none; }
        .active { display: block; }
        
        @media (max-width: 600px) {
            .main-content { flex-direction: column-reverse; height: auto; }
            .game-log { height: 200px; }
        }
    </style>
</head>
<body>

<div class="game-container">
    <div id="notification-area"></div>

    <h1>ğŸ° ç„¡ç›¡è©¦ç…‰ v3.0</h1>

    <div id="screen-start" class="screen active">
        <h3>é¸æ“‡è·æ¥­</h3>
        <div class="controls">
            <button onclick="startGame('barbarian')">ğŸª“ é‡è »äºº</button>
            <button onclick="startGame('assassin')">ğŸ—¡ï¸ åˆºå®¢</button>
            <button onclick="startGame('mage')">ğŸ”¥ æ³•å¸«</button>
            <button onclick="startGame('warlock')">ğŸ”® è¡“å£«</button>
            <button onclick="startGame('knight')">ğŸ›¡ï¸ é¨å£«</button>
        </div>
        <div class="controls">
            <button class="btn-achievement" onclick="showAchievements()">ğŸ† æŸ¥çœ‹æˆå°±åˆ—è¡¨</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="top-panel">
            <div><span id="ui-class"></span> Lv.<span id="ui-floor">1</span></div>
            <div class="danger">HP <span id="ui-hp"></span>/<span id="ui-maxhp"></span></div>
            <div class="highlight">ATK <span id="ui-atk"></span></div>
            <div class="success">DEF <span id="ui-def"></span></div>
        </div>

        <div class="main-content">
            <div class="equipment-grid" id="equip-display">
                </div>
            <div id="game-log" class="game-log"></div>
        </div>

        <div class="controls" id="action-area"></div>
    </div>

    <div id="screen-over" class="screen" style="text-align:center;">
        <h2 class="danger">ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
        <p>æœ€çµ‚å±¤æ•¸: <span id="final-floor" class="highlight"></span></p>
        <div class="controls">
            <button onclick="location.reload()">é‡æ–°é–‹å§‹</button>
            <button class="btn-achievement" onclick="showAchievements()">ğŸ† æŸ¥çœ‹æˆå°±</button>
        </div>
    </div>
</div>

<div id="modal-loot" class="modal-overlay">
    <div class="modal-content">
        <h3>ğŸ ç²å¾—æˆ°åˆ©å“!</h3>
        <div class="compare-grid">
            <div class="compare-card" style="opacity: 0.7;">
                <h4>ç›®å‰è£å‚™</h4>
                <div id="loot-current">ç„¡</div>
            </div>
            <div class="compare-card" style="border: 1px solid var(--accent-color);">
                <h4 class="highlight">æ–°è£å‚™</h4>
                <div id="loot-new"></div>
            </div>
        </div>
        <div class="controls">
            <button class="btn-heal" onclick="confirmLoot(true)">è£å‚™</button>
            <button class="btn-atk" onclick="confirmLoot(false)">ä¸Ÿæ£„</button>
        </div>
    </div>
</div>

<div id="modal-achievements" class="modal-overlay" onclick="if(event.target === this) this.style.display='none'">
    <div class="modal-content">
        <h3>ğŸ† æˆå°±ç´€éŒ„</h3>
        <p style="text-align:center; font-size:0.8rem; color:#888;">æˆå°±é€²åº¦æœƒè‡ªå‹•å„²å­˜åœ¨æ­¤ç€è¦½å™¨ä¸­</p>
        <div id="achievement-list" class="achieve-grid">
            </div>
        <div class="controls" style="margin-top:20px;">
            <button onclick="document.getElementById('modal-achievements').style.display='none'">é—œé–‰</button>
            <button class="btn-atk" onclick="resetAchievements()">é‡ç½®æˆå°±</button>
        </div>
    </div>
</div>

<script>
    /* --- éŠæˆ²è³‡æ–™èˆ‡å¸¸æ•¸ --- */
    const CLASSES = {
        barbarian: { name: "é‡è »äºº", hp: 120, atk: 12, def: 2 },
        assassin: { name: "åˆºå®¢", hp: 80, atk: 15, def: 1 },
        mage: { name: "æ³•å¸«", hp: 60, atk: 20, def: 0 },
        warlock: { name: "è¡“å£«", hp: 90, atk: 12, def: 1 },
        knight: { name: "é¨å£«", hp: 110, atk: 9, def: 5 }
    };

    const SLOTS = ['mainHand', 'offHand', 'chest', 'helm', 'boots', 'ring', 'necklace'];
    const SLOT_NAMES = { mainHand: "ä¸»æ‰‹", offHand: "å‰¯æ‰‹", chest: "èƒ¸ç”²", helm: "é ­ç›”", boots: "é‹å­", ring: "æˆ’æŒ‡", necklace: "é …éŠ" };

    // æˆå°±å®šç¾©
    const ACHIEVEMENTS = [
        { id: 'first_step', title: 'åˆå‡ºèŒ…å»¬', desc: 'é–‹å§‹ç¬¬ä¸€æ¬¡éŠæˆ²' },
        { id: 'floor_10', title: 'æ¢éšªå®¶', desc: 'åˆ°é”ç¬¬ 10 å±¤' },
        { id: 'floor_30', title: 'æ·±æ·µè¡Œè€…', desc: 'åˆ°é”ç¬¬ 30 å±¤' },
        { id: 'floor_50', title: 'å‚³å¥‡è‹±é›„', desc: 'åˆ°é”ç¬¬ 50 å±¤' },
        { id: 'high_dmg', title: 'ä¸€æ“Šå¿…æ®º', desc: 'å–®æ¬¡æ”»æ“Šé€ æˆè¶…é 80 é»å‚·å®³' },
        { id: 'iron_wall', title: 'éŠ…ç‰†éµå£', desc: 'é˜²ç¦¦åŠ›è¶…é 20' },
        { id: 'full_gear', title: 'å…¨å‰¯æ­¦è£', desc: 'æ‰€æœ‰è£å‚™æ¬„ä½éƒ½ç©¿ä¸Šè£å‚™' },
        { id: 'rich', title: 'è²¡å¯Œè‡ªç”±', desc: 'æŒæœ‰é‡‘å¹£è¶…é 500' },
        { id: 'hoarder', title: 'è—¥ç½å­', desc: 'åŒæ™‚æŒæœ‰ 10 ç“¶è—¥æ°´' },
        { id: 'lucky', title: 'å¹¸é‹ä¸€æ“Š', desc: 'è§¸ç™¼ä¸€æ¬¡çˆ†æ“Š' },
        { id: 'untouchable', title: 'æ¯«é«®ç„¡å‚·', desc: 'å—åˆ°æ”»æ“Šä½†å‚·å®³ç‚º 0' },
        { id: 'death', title: 'å‹‡è€…é•·çœ ', desc: 'ç¬¬ä¸€æ¬¡æ­»äº¡' }
    ];

    // è£å‚™åº« (ç‚ºäº†ç°¡æ½”ï¼Œé€™è£¡ä¿ç•™æ ¸å¿ƒçµæ§‹ï¼Œå¯¦éš›é¡å‹å¯æ“´å……)
    const ITEM_DB = {
        mainHand: [
            { name: "ç”Ÿé½éµåŠ", stats: { atk: 3 }, allowed: null },
            { name: "æˆ°æ–§", stats: { atk: 5, spd: -1 }, allowed: ['barbarian', 'knight'] },
            { name: "åŒ•é¦–", stats: { atk: 3, crit: 5 }, allowed: ['assassin', 'warlock'] },
            { name: "æ³•æ–", stats: { atk: 6 }, allowed: ['mage', 'warlock'] },
            { name: "é•·åŠ", stats: { atk: 5, def: 1 }, allowed: ['knight'] },
            { name: "å·¨éŒ˜", stats: { atk: 8 }, allowed: ['barbarian'] },
            { name: "éª¨åˆ€", stats: { atk: 4, hp: 5 }, allowed: ['warlock'] },
            { name: "é­”å°æ›¸", stats: { atk: 7 }, allowed: ['mage'] },
            { name: "å¿è€…åˆ€", stats: { atk: 6, crit: 3 }, allowed: ['assassin'] },
            { name: "ç‹è€…ä¹‹åŠ", stats: { atk: 10 }, allowed: null }
        ],
        offHand: [
            { name: "æœ¨ç›¾", stats: { def: 2 }, allowed: ['knight', 'barbarian'] },
            { name: "åœ“ç›¾", stats: { def: 3 }, allowed: ['knight'] },
            { name: "å¯¶ç ", stats: { atk: 2 }, allowed: ['mage', 'warlock'] },
            { name: "æ‹›æ¶åŒ•é¦–", stats: { def: 1, crit: 2 }, allowed: ['assassin'] },
            { name: "æç‡ˆ", stats: { def: 1 }, allowed: null }
        ],
        chest: [
            { name: "çš®ç”²", stats: { def: 2 }, allowed: null },
            { name: "é–å­ç”²", stats: { def: 4 }, allowed: ['knight', 'barbarian'] },
            { name: "é•·è¢", stats: { def: 1, atk: 2 }, allowed: ['mage', 'warlock'] },
            { name: "æ¿ç”²", stats: { def: 8, spd: -2 }, allowed: ['knight'] }
        ],
        helm: [
            { name: "é ­å¸¶", stats: { atk: 1 }, allowed: null },
            { name: "éµç›”", stats: { def: 3 }, allowed: ['knight', 'barbarian'] },
            { name: "å…œå¸½", stats: { def: 1, crit: 1 }, allowed: ['assassin'] }
        ],
        boots: [
            { name: "çš®é´", stats: { def: 1 }, allowed: null },
            { name: "éµé´", stats: { def: 3 }, allowed: ['knight'] },
            { name: "ä¾¿é‹", stats: { atk: 1 }, allowed: ['mage'] }
        ],
        ring: [
            { name: "éµæˆ’æŒ‡", stats: { def: 1 }, allowed: null },
            { name: "å¯¶çŸ³æˆ’", stats: { atk: 2 }, allowed: null },
            { name: "ç”Ÿå‘½æˆ’", stats: { hp: 10 }, allowed: null }
        ],
        necklace: [
            { name: "è­·èº«ç¬¦", stats: { def: 1 }, allowed: null },
            { name: "ç‰™é½’é …éŠ", stats: { atk: 1, crit: 1 }, allowed: null }
        ]
    };

    /* --- éŠæˆ²ç‹€æ…‹ --- */
    let player = {
        base: {}, currentHp: 0, potions: 2, gold: 0, equipment: {}, classKey: ''
    };
    let floor = 0;
    let tempLoot = null;
    let enemy = null;
    let unlockedAchievements = [];

    /* --- åˆå§‹åŒ– --- */
    window.onload = function() {
        loadAchievements();
    };

    function loadAchievements() {
        const stored = localStorage.getItem('tower_game_achievements');
        if (stored) {
            unlockedAchievements = JSON.parse(stored);
        }
    }

    function checkAchievement(id) {
        if (!unlockedAchievements.includes(id)) {
            unlockedAchievements.push(id);
            localStorage.setItem('tower_game_achievements', JSON.stringify(unlockedAchievements));
            
            // é¡¯ç¤ºé€šçŸ¥
            const ach = ACHIEVEMENTS.find(a => a.id === id);
            showToast(`ğŸ† æˆå°±è§£é–ï¼š${ach.title}`);
        }
    }

    function showToast(msg) {
        const area = document.getElementById('notification-area');
        const div = document.createElement('div');
        div.className = 'toast';
        div.innerHTML = msg;
        area.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }

    function resetAchievements() {
        if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æˆå°±ç´€éŒ„å—ï¼Ÿ")) {
            localStorage.removeItem('tower_game_achievements');
            unlockedAchievements = [];
            showAchievements(); // refresh
        }
    }

    function showAchievements() {
        const list = document.getElementById('achievement-list');
        list.innerHTML = '';
        ACHIEVEMENTS.forEach(ach => {
            const isUnlocked = unlockedAchievements.includes(ach.id);
            const div = document.createElement('div');
            div.className = `achieve-item ${isUnlocked ? 'unlocked' : ''}`;
            div.innerHTML = `
                <div class="achieve-info">
                    <h4>${ach.title}</h4>
                    <p>${ach.desc}</p>
                </div>
                <div class="achieve-status">
                    ${isUnlocked ? 'âœ…' : 'ğŸ”’'}
                </div>
            `;
            list.appendChild(div);
        });
        document.getElementById('modal-achievements').style.display = 'flex';
    }

    /* --- éŠæˆ²é‚è¼¯ --- */
    function log(msg, type='') {
        const el = document.getElementById('game-log');
        const div = document.createElement('div');
        div.className = 'log-entry ' + type;
        div.innerHTML = msg;
        el.appendChild(div);
        el.scrollTop = el.scrollHeight;
    }

    function startGame(classKey) {
        const cls = CLASSES[classKey];
        player = {
            classKey: classKey,
            base: { ...cls },
            currentHp: cls.hp,
            potions: 2,
            gold: 0,
            equipment: {}
        };
        SLOTS.forEach(slot => player.equipment[slot] = null);
        
        floor = 0;
        document.getElementById('screen-start').classList.remove('active');
        document.getElementById('screen-over').classList.remove('active');
        document.getElementById('screen-game').classList.add('active');
        
        // åˆå§‹è£å‚™
        const starterWeapons = {
            barbarian: ITEM_DB.mainHand[1],
            assassin: ITEM_DB.mainHand[2],
            mage: ITEM_DB.mainHand[3],
            warlock: ITEM_DB.mainHand[6],
            knight: ITEM_DB.mainHand[4]
        };
        equip(JSON.parse(JSON.stringify(starterWeapons[classKey])), 'mainHand', true);

        checkAchievement('first_step'); // æˆå°±æª¢æŸ¥
        updateUI();
        log(`ä½ é¸æ“‡äº† ${cls.name}ï¼Œè¸å…¥è©¦ç…‰ä¹‹å¡”ï¼`);
        nextFloor();
    }

    function getPlayerStats() {
        let stats = { hp: player.base.hp, atk: player.base.atk, def: player.base.def, crit: 0 };
        for (let slot of SLOTS) {
            const item = player.equipment[slot];
            if (item && item.stats) {
                if (item.stats.hp) stats.hp += item.stats.hp;
                if (item.stats.atk) stats.atk += item.stats.atk;
                if (item.stats.def) stats.def += item.stats.def;
                if (item.stats.crit) stats.crit += item.stats.crit;
            }
        }
        return stats;
    }

    function updateUI() {
        const stats = getPlayerStats();
        if (player.currentHp > stats.hp) player.currentHp = stats.hp;

        document.getElementById('ui-class').innerText = CLASSES[player.classKey].name;
        document.getElementById('ui-floor').innerText = floor;
        document.getElementById('ui-hp').innerText = Math.floor(player.currentHp);
        document.getElementById('ui-maxhp').innerText = stats.hp;
        document.getElementById('ui-atk').innerText = stats.atk;
        document.getElementById('ui-def').innerText = stats.def;

        const grid = document.getElementById('equip-display');
        grid.innerHTML = '';
        SLOTS.forEach(slot => {
            const item = player.equipment[slot];
            const div = document.createElement('div');
            div.className = 'equip-slot';
            div.innerHTML = `
                <span class="label">${SLOT_NAMES[slot]}</span>
                <span class="item-name">${item ? item.name : '---'}</span>
            `;
            if (item) {
                let txt = '';
                for (let k in item.stats) txt += `${k.toUpperCase()}+${item.stats[k]} `;
                div.title = txt;
            }
            grid.appendChild(div);
        });

        // æˆå°±æª¢æŸ¥ï¼šé˜²ç¦¦åŠ›ã€è²¡å¯Œã€è—¥æ°´
        if (stats.def >= 20) checkAchievement('iron_wall');
        if (player.gold >= 500) checkAchievement('rich');
        if (player.potions >= 10) checkAchievement('hoarder');
        
        // æˆå°±æª¢æŸ¥ï¼šå…¨èº«è£å‚™
        const isFull = SLOTS.every(s => player.equipment[s] !== null);
        if (isFull) checkAchievement('full_gear');
    }

    function nextFloor() {
        floor++;
        
        // æˆå°±æª¢æŸ¥ï¼šæ¨“å±¤
        if (floor >= 10) checkAchievement('floor_10');
        if (floor >= 30) checkAchievement('floor_30');
        if (floor >= 50) checkAchievement('floor_50');

        updateUI();
        log(`<br>--- <strong>ç¬¬ ${floor} å±¤</strong> ---`, 'highlight');
        
        const rand = Math.random();
        if (floor % 10 === 0) {
            encounterMonster(true);
        } else if (rand < 0.7) {
            encounterMonster(false);
        } else {
            triggerEvent();
        }
    }

    function encounterMonster(isBoss) {
        const scale = 1 + (floor * 0.1);
        const names = ["å²èŠå§†", "å“¥å¸ƒæ—", "éª·é«å…µ", "ç¸äºº", "å¹½éˆ", "çŸ³åƒé¬¼", "é£Ÿäººé­”", "é»‘é¨å£«", "é›™è¶³é£›é¾", "æƒ¡é­”"];
        const nameIdx = isBoss ? 9 : Math.min(names.length - 2, Math.floor(floor / 5));
        
        enemy = {
            name: (isBoss ? "é¦–é ˜: " : "") + names[isBoss ? 9 : Math.floor(Math.random() * (nameIdx + 1))],
            maxHp: Math.floor((isBoss ? 150 : 30) * scale),
            currentHp: Math.floor((isBoss ? 150 : 30) * scale),
            atk: Math.floor((isBoss ? 15 : 5) * scale) + floor,
        };
        log(`é­é‡æ•µè¥²ï¼š<span class="danger">${enemy.name}</span> (HP:${enemy.maxHp}, ATK:${enemy.atk})`);
        renderCombatControls();
    }

    function renderCombatControls() {
        const area = document.getElementById('action-area');
        area.innerHTML = '';
        
        const atkBtn = document.createElement('button');
        atkBtn.className = 'btn-atk';
        atkBtn.innerText = 'âš”ï¸ æ”»æ“Š';
        atkBtn.onclick = combatRound;
        area.appendChild(atkBtn);

        const potBtn = document.createElement('button');
        potBtn.className = 'btn-heal';
        potBtn.innerText = `ğŸ§ª è—¥æ°´(${player.potions})`;
        potBtn.onclick = usePotion;
        if (player.potions <= 0) potBtn.disabled = true;
        area.appendChild(potBtn);
    }

    function combatRound() {
        const stats = getPlayerStats();
        
        // ç©å®¶æ”»æ“Š
        let isCrit = Math.random() * 100 < stats.crit;
        if (isCrit) checkAchievement('lucky'); // æˆå°±æª¢æŸ¥

        let dmg = Math.floor(stats.atk * (isCrit ? 1.5 : 1) * (0.9 + Math.random()*0.2));
        
        if (dmg >= 80) checkAchievement('high_dmg'); // æˆå°±æª¢æŸ¥

        enemy.currentHp -= dmg;
        log(`ä½ å° ${enemy.name} é€ æˆ ${dmg} å‚·å®³${isCrit?' (çˆ†æ“Š!)':''}ã€‚`);

        if (enemy.currentHp <= 0) {
            log(`æˆ°å‹äº† ${enemy.name}ï¼`, 'success');
            player.gold += Math.floor(Math.random() * 10) + floor;
            winReward();
            return;
        }

        // æ€ªç‰©æ”»æ“Š
        let incoming = Math.max(1, Math.floor((enemy.atk - stats.def) * (0.9 + Math.random()*0.2)));
        
        // æˆå°±æª¢æŸ¥ï¼šæ ¼æ“‹/é˜²ç¦¦é«˜å°è‡´0å‚· (ç³»çµ±è¨­å®šæœ€å°‘1ï¼Œä½†å¦‚æœæœªä¾†æ”¹å…¬å¼æœ‰å¯èƒ½0ï¼Œé€™è£¡æš«æ™‚æ¨¡æ“¬)
        // ç‚ºäº†è®“æˆå°±æœ‰æ©Ÿæœƒé”æˆï¼Œæˆ‘å€‘ä¿®æ”¹è¦å‰‡ï¼šå¦‚æœé˜²ç¦¦å¤ é«˜ï¼Œéš¨æ©Ÿæœ‰æ©Ÿæœƒå®Œå…¨æ ¼æ“‹
        if (stats.def > enemy.atk && Math.random() > 0.5) {
            incoming = 0;
            checkAchievement('untouchable');
            log(`ğŸ›¡ï¸ å®Œç¾çš„é˜²ç¦¦ï¼ä½ æ“‹ä¸‹äº†æ‰€æœ‰å‚·å®³ï¼`, 'success');
        } else {
            player.currentHp -= incoming;
            log(`${enemy.name} åæ“Šï¼Œä½ å—åˆ° ${incoming} å‚·å®³ã€‚`, 'danger');
        }
        
        updateUI();
        if (player.currentHp <= 0) gameOver();
    }

    function usePotion() {
        if (player.potions > 0) {
            player.potions--;
            const heal = 50;
            const stats = getPlayerStats();
            player.currentHp = Math.min(stats.hp, player.currentHp + heal);
            log(`ä½¿ç”¨äº†è—¥æ°´ï¼Œå›å¾© ${heal} HPã€‚`, 'success');
            
            // æ€ªç‰©è¶æ©Ÿæ”»æ“Š
            let incoming = Math.floor(enemy.atk * 0.8);
            player.currentHp -= incoming;
            log(`${enemy.name} è¶æ©Ÿæ”»æ“Šï¼Œé€ æˆ ${incoming} å‚·å®³ã€‚`);
            
            updateUI();
            if (player.currentHp <= 0) gameOver();
        }
    }

    function winReward() {
        if (Math.random() < 0.5) {
             generateLoot();
        } else {
            log("æ€ªç‰©æ‰è½äº†ä¸€äº›é‡‘å¹£ã€‚");
            renderNextButton();
        }
    }

    function triggerEvent() {
        const evts = [
            { t: "ç™¼ç¾å¯¶ç®±", act: () => { log("æ‰“é–‹å¯¶ç®±ï¼Œç™¼ç¾è£å‚™ï¼", 'highlight'); generateLoot(); } },
            { t: "é‡åˆ°å•†äºº", act: () => { 
                log("å•†äººé€äº†ä½ ä¸€ç“¶è—¥æ°´ã€‚"); 
                player.potions++; 
                renderNextButton(); 
            }},
            { t: "ç¥ç§˜æ³‰æ°´", act: () => { 
                log("å–ä¸‹æ³‰æ°´ï¼Œå‚·å‹¢å®Œå…¨æ¢å¾©ã€‚"); 
                player.currentHp = getPlayerStats().hp; 
                renderNextButton(); 
            }},
            { t: "å°éŒ¢è¢‹", act: () => {
                let g = 50;
                log(`æ’¿åˆ°éŒ¢è¢‹ï¼Œç²å¾— ${g} é‡‘å¹£ã€‚`, 'success');
                player.gold += g;
                renderNextButton();
            }}
        ];
        const evt = evts[Math.floor(Math.random() * evts.length)];
        log(`äº‹ä»¶: ${evt.t}`);
        evt.act();
        updateUI();
    }

    function generateLoot() {
        const slot = SLOTS[Math.floor(Math.random() * SLOTS.length)];
        // é€™è£¡ç°¡åŒ–è³‡æ–™åº«å­˜å–ï¼Œéš¨æ©Ÿå–ä¸€å€‹è©²éƒ¨ä½çš„è£å‚™
        // ç‚ºäº†å®Œæ•´æ€§ï¼Œè‹¥è³‡æ–™åº«è©²éƒ¨ä½æ²’æœ‰ç¬¦åˆè·æ¥­çš„è£å‚™ï¼Œå°±çµ¦é€šç”¨è£å‚™
        let candidates = ITEM_DB[slot].filter(item => item.allowed === null || item.allowed.includes(player.classKey));
        if (candidates.length === 0) candidates = ITEM_DB[slot].filter(item => item.allowed === null);

        if (candidates.length === 0) {
            renderNextButton(); return;
        }

        const baseItem = candidates[Math.floor(Math.random() * candidates.length)];
        let newItem = JSON.parse(JSON.stringify(baseItem));
        newItem.slot = slot;
        
        const multiplier = 1 + (floor * 0.15);
        for (let key in newItem.stats) {
            if (newItem.stats[key] > 0) newItem.stats[key] = Math.ceil(newItem.stats[key] * multiplier * (0.8 + Math.random() * 0.4));
        }

        if (Math.random() < 0.2) {
            newItem.name = "ç²¾è‰¯çš„ " + newItem.name;
            newItem.stats.atk = (newItem.stats.atk || 0) + Math.ceil(floor/2);
        }

        tempLoot = newItem;
        showLootModal(newItem);
    }

    function showLootModal(newItem) {
        const modal = document.getElementById('modal-loot');
        const currentItem = player.equipment[newItem.slot];

        let curHtml = currentItem ? `<strong>${currentItem.name}</strong><br>` : "ç„¡<br>";
        if (currentItem) for (let k in currentItem.stats) curHtml += `${k.toUpperCase()}: ${currentItem.stats[k]}<br>`;
        document.getElementById('loot-current').innerHTML = curHtml;

        let newHtml = `<strong>${newItem.name}</strong><br>`;
        for (let k in newItem.stats) {
            let diff = newItem.stats[k] - (currentItem && currentItem.stats[k] ? currentItem.stats[k] : 0);
            let colorClass = diff > 0 ? 'stat-diff-pos' : (diff < 0 ? 'stat-diff-neg' : '');
            newHtml += `${k.toUpperCase()}: ${newItem.stats[k]} <span class="${colorClass}">(${diff>0?'+':''}${diff})</span><br>`;
        }
        document.getElementById('loot-new').innerHTML = newHtml;

        modal.style.display = 'flex';
    }

    function confirmLoot(accept) {
        document.getElementById('modal-loot').style.display = 'none';
        if (accept && tempLoot) {
            equip(tempLoot, tempLoot.slot);
        }
        tempLoot = null;
        renderNextButton();
    }

    function equip(item, slot, silent=false) {
        player.equipment[slot] = item;
        updateUI();
        if (!silent) log(`è£å‚™äº† <span class="highlight">${item.name}</span>ï¼`, 'success');
    }

    function renderNextButton() {
        const area = document.getElementById('action-area');
        area.innerHTML = '';
        const btn = document.createElement('button');
        btn.innerText = 'å‰å¾€ä¸‹ä¸€å±¤';
        btn.onclick = nextFloor;
        area.appendChild(btn);
    }

    function gameOver() {
        checkAchievement('death');
        document.getElementById('screen-game').classList.remove('active');
        document.getElementById('screen-over').classList.add('active');
        document.getElementById('final-floor').innerText = floor;
    }
</script>
</body>
</html>